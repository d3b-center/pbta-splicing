---
title: "Run survival analyses with SI"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Ryan Corbett
date: 2023
params:
  plot_ci: TRUE
---

**Purpose:** 

Runs survival analysis models in histology groups with splicing burden index (SBI) as a predictor

## Usage 

Uses a wrapper function (`survival_analysis`) from utils folder. 

## Setup

#### Packages and functions

Load packages, set directory paths and call setup script

```{r}
library(tidyverse)
library(survival)
library(ggpubr)
library(ggplot2)

root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))

data_dir <- file.path(root_dir, "data")
analysis_dir <- file.path(root_dir, "analyses", "survival")
input_dir <- file.path(analysis_dir, "results")
results_dir <- file.path(analysis_dir, "results")

# If the input and results directories do not exist, create it
if (!dir.exists(results_dir)) {
  dir.create(results_dir, recursive = TRUE)
}

source(file.path(analysis_dir, "util", "survival_models.R"))
```

Set metadata path

```{r set paths}
metadata_file <- file.path(input_dir, "splicing_indices_with_survival.tsv")
```

Read in metadata and consolidate HGG, LGG, and GNG subtypes

```{r}
metadata <- read_tsv(metadata_file)

metadata <- metadata %>%
  filter(!grepl("To be classified", molecular_subtype)) %>%
  mutate(mol_sub_group = case_when(
    Histology == "LGG" & grepl("SEGA", molecular_subtype) ~ "SEGA",
    Histology == "LGG" & grepl("wildtype", molecular_subtype) ~ "LGG, WT",
    Histology == "LGG" & grepl("-BRAF", molecular_subtype) ~ "LGG, BRAF fusion",
    Histology == "LGG" ~ "LGG, Other alteration",
    Histology == "GNG" & grepl("wildtype", molecular_subtype) ~ "GNG, WT",
    Histology == "GNG" & grepl("-BRAF", molecular_subtype) ~ "GNG, BRAF fusion",
    Histology == "GNG" ~ "GNG, Other alteration",
    !is.na(molecular_subtype) ~ molecular_subtype
  ))
```

Define histology groups to run survival analyses on 

```{r}
groups <- c("ATRT", "CPG", "EPN", "GNG", 
            "HGG", "LGG", "MB")

# create names vector for output files
plot_names <- c("atrt", "cpg", "epn", 
                "gng", "hgg", "lgg", "mb")
names(plot_names) <- groups
```

Loop through histology groups and perform the following: 

- Filter metadta by histology
- Multiply SI by 10 for modeling purposes (scale coefficients down for plotting)
- Run cox proportional hazard models, including SI burden as covariate along with subtype (when applicable) and extent of tumor resection (LGG only). Save output for plotting

```{r}
for (group in groups){
  
  results_dir <- file.path(analysis_dir, "results", group)
  
  if (!dir.exists(results_dir)) {
    dir.create(results_dir)
      
    }

  coxph_os_model_file <- ifelse(group %in% c("GNG", "LGG"),
                             file.path(results_dir,
                                       glue::glue("cox_{plot_names[group]}_OS_additive_terms_subtype_resection_SI.RDS")),
                             file.path(results_dir,
                                       glue::glue("cox_{plot_names[group]}_OS_additive_terms_subtype_SI.RDS"))
  )

  coxph_efs_model_file <- ifelse(group %in% c("GNG", "LGG"),
                             file.path(results_dir,
                                       glue::glue("cox_{plot_names[group]}_EFS_additive_terms_subtype_resection_SI.RDS")),
                             file.path(results_dir,
                                       glue::glue("cox_{plot_names[group]}_EFS_additive_terms_subtype_SI.RDS"))
  )
  
    # Subset histology
  group_hist <- metadata %>%
    filter(grepl(group, Histology))
  
  # Subset histology and transform SI 
  
    if (group %in% c("LGG", "GNG")){
      
      group_hist <- group_hist %>%
        filter(!is.na(mol_sub_group) & !is.na(OS_days) & !is.na(EFS_days) & !is.na(extent_of_tumor_resection) & !extent_of_tumor_resection %in% c("Unavailable", "Not Applicable")) %>%
        dplyr::mutate(SI_SE = SI_SE * 10)
      
    } else {
      
      group_hist <- group_hist %>%
        filter(!is.na(mol_sub_group) & !is.na(OS_days) & !is.na(EFS_days)) %>%
        dplyr::mutate(SI_SE = SI_SE * 10)
      
    }
  
  # consolidate HGG subtypes into broader groups
  if (group == "HGG"){
    group_hist <- group_hist %>%
     dplyr::mutate(mol_sub_group = factor(mol_sub_group)) %>% 
     dplyr::mutate(mol_sub_group = fct_relevel(mol_sub_group, c("HGG, H3 wildtype", "HGG, H3 wildtype, TP53",
                                                                "DHG, H3 G35", "DHG, H3 G35, TP53",
                                                                "DMG, H3 K28", "DMG, H3 K28, TP53",
                                                                "HGG, IDH, TP53",
                                                                "IHG, ALK-altered", "IHG, NTRK-altered",
                                                                "IHG, NTRK-altered, TP53", "IHG, ROS1-altered"
                                                                ))) %>%
   arrange(molecular_subtype)
  }
  
  if (group == "LGG"){
    group_hist <- group_hist %>%
     dplyr::mutate(mol_sub_group = factor(mol_sub_group)) %>% 
     dplyr::mutate(mol_sub_group = fct_relevel(mol_sub_group, c("LGG, WT", "LGG, BRAF fusion",
                                                                "LGG, Other alteration", "SEGA"
                                                                ))) %>%
      dplyr::mutate(extent_of_tumor_resection = factor(extent_of_tumor_resection)) %>%
      dplyr::mutate(extent_of_tumor_resection = fct_relevel(extent_of_tumor_resection,
                                                            c("Gross/Near total resection",
                                                              "Partial resection",
                                                              "Biopsy only")))
  }
  
  if (group == "EPN"){
    group_hist <- group_hist %>%
     dplyr::mutate(mol_sub_group = factor(mol_sub_group)) %>% 
     dplyr::mutate(mol_sub_group = fct_relevel(mol_sub_group, c("EPN, PF A", "EPN, PF B",
                                                                "EPN, ST ZFTA", "EPN, ST YAP1",
                                                                "EPN, MPE", "EPN, SP", "EPN, SP-MYCN"
                                                                ))) %>%
   arrange(molecular_subtype)
  }
  
  if (group == "GNG"){
    group_hist <- group_hist %>%
     dplyr::mutate(mol_sub_group = factor(mol_sub_group)) %>% 
     dplyr::mutate(mol_sub_group = fct_relevel(mol_sub_group, c("GNG, WT", "GNG, BRAF fusion",
                                                                "GNG, Other alteration"
                                                                ))) %>%
      dplyr::mutate(extent_of_tumor_resection = factor(extent_of_tumor_resection)) %>%
      dplyr::mutate(extent_of_tumor_resection = fct_relevel(extent_of_tumor_resection,
                                                            c("Gross/Near total resection",
                                                              "Partial resection",
                                                              "Biopsy only")))
  }
  
  if (group == "MB"){
    group_hist <- group_hist %>%
     dplyr::mutate(mol_sub_group = factor(mol_sub_group)) %>% 
     dplyr::mutate(mol_sub_group = fct_relevel(mol_sub_group, c("MB, WNT", "MB, Group3",
                                                                "MB, Group4", "MB, SHH"
                                                                )))
    }
  
  # Run cox proprtional hazards models for OS, including appropriate covariates per histology
  add_model_os <- suppressWarnings(
                                fit_save_model(group_hist,
                                  terms = ifelse(
                                      group %in% c("GNG", "LGG"), "mol_sub_group+extent_of_tumor_resection+SI_SE",
                                      ifelse(group %in% c("ATRT", "EPN", "HGG", "MB"),
                                             "mol_sub_group+SI_SE",
                                              "SI_SE"
                                  )),
             coxph_os_model_file,
             "multivariate",
             years_col = "OS_years",
             status_col = "OS_status"
            ))
  
  # Run cox proprtional hazards models for PFS, including appropriate covariates per histology
  add_model_efs <- suppressWarnings(
                            fit_save_model(group_hist,
                                  terms = ifelse(
                                      group %in% c("GNG", "LGG"), "mol_sub_group+extent_of_tumor_resection+SI_SE",
                                      ifelse(group %in% c("ATRT", "EPN", "HGG", "MB"),
                                             "mol_sub_group+SI_SE",
                                              "SI_SE"
                                  )),
             coxph_efs_model_file,
             "multivariate",
             years_col = "EFS_years",
             status_col = "EFS_status"
            ))
  
}

```

Run same survival analyses on HGG, LGG, and MB subtypes with sufficient sample size

```{r}
# define subtype df with histology, subtype, and file names
subtype_df <- data.frame(hist = c("CPG",
                                  "EPN",
                                  rep("HGG", 2),
                                  "GNG",
                                  rep("LGG", 3),
                                  rep("MB", 3)),
                         names = c("cranio",
                                  "epn",
                                  rep("hgg", 2),
                                  "gng_gnt",
                                  rep("lgg", 3),
                                  rep("mb", 3)),
                         subtype = c("ADAM", "PF A", "K28", "wildtype",
                                     "Other", "BRAF", "Other", "WT", 
                                     "Group3", "Group4", "SHH"))

# Loop through subtypes and run survival analyses
for (i in 1:nrow(subtype_df)) {
  
  results_dir <- file.path(analysis_dir, "results", subtype_df$hist[i])
  
  # define output files

  coxph_os_model_file <- ifelse(subtype_df$hist[i] %in% c("LGG", "GNG"),
                             file.path(results_dir,
                                      glue::glue("cox_{subtype_df$names[i]}_{subtype_df$subtype[i]}_OS_additive_terms_subtype_resection_SI.RDS")),
                             file.path(results_dir,
                                       glue::glue("cox_{subtype_df$names[i]}_{subtype_df$subtype[i]}_OS_additive_terms_subtype_SI.RDS"))
  )

  coxph_efs_model_file <- ifelse(subtype_df$hist[i] %in% c("LGG", "GNG"),
                             file.path(results_dir,
                                       glue::glue("cox_{subtype_df$names[i]}_{subtype_df$subtype[i]}_EFS_additive_terms_subtype_resection_SI.RDS")),
                             file.path(results_dir,
                                       glue::glue("cox_{subtype_df$names[i]}_{subtype_df$subtype[i]}_EFS_additive_terms_subtype_SI.RDS"))
  )
  
    #Subset metadata for histology subtype
    subtype_hist <- metadata %>%
      filter(Histology == subtype_df$hist[i] & grepl(subtype_df$subtype[i], mol_sub_group) & !is.na(OS_days) & !is.na(EFS_days)) %>%
      dplyr::mutate(SI_SE = SI_SE * 10)
    
    if (subtype_df$hist[i] %in% c("LGG", "GNG")){

      subtype_hist <- subtype_hist %>%
        filter(!is.na(extent_of_tumor_resection) & !extent_of_tumor_resection %in% c("Unavailable", "Not Applicable"))
      
    }


    # Run coxph models and save to output
    add_model_os <- suppressWarnings(
                              fit_save_model(subtype_hist,
                                  terms = ifelse(subtype_df$hist[i] %in% c("GNG", "LGG"),
                                                 "extent_of_tumor_resection+SI_SE",
                                                 ifelse(subtype_df$hist[i] == "HGG",
                                                        "mol_sub_group+SI_SE",
                                                        "SI_SE"
                                                        )),
                                   coxph_os_model_file,
                                   "multivariate",
                                   years_col = "OS_years",
                                   status_col = "OS_status"))
    
    add_model_efs <- suppressWarnings(
                              fit_save_model(subtype_hist,
                                  terms = ifelse(subtype_df$hist[i] %in% c("GNG", "LGG"),
                                                 "extent_of_tumor_resection+SI_SE",
                                                 ifelse(subtype_df$hist[i] == "HGG",
                                                        "mol_sub_group+SI_SE",
                                                        "SI_SE"
                                                        )),
                                     coxph_efs_model_file,
                                     "multivariate",
                                     years_col = "EFS_years",
                                     status_col = "EFS_status"
                                    ))

}

```