---
title: "Prepare splicing data for survival analyses"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Ryan Corbett
date: 2023
params:
  plot_ci: TRUE
---

**Purpose:** 

- Add sample survival data to splicing index file to run survival analyses
- Add additional subtype data from methylation to improve subtype-specific analyses

## Setup

#### Packages and functions

load libraries and set directories
```{r Set up library}
library(survival)
library(ggpubr)
library(tidyverse)

# Set directories
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
data_dir <- file.path(root_dir, "data")
analysis_dir <- file.path(root_dir, "analyses", "survival")
input_dir <- file.path(analysis_dir, "input")
results_dir <- file.path(analysis_dir, "results")

# Magrittr pipe
`%>%` <- dplyr::`%>%`
```

Set file paths

```{r}
sbi_A3SS_file <- file.path(root_dir, "analyses", "splicing_index", "results", "splicing_index.A3SS.txt")
sbi_A5SS_file <- file.path(root_dir, "analyses", "splicing_index", "results", "splicing_index.A5SS.txt")
sbi_RI_file <- file.path(root_dir, "analyses", "splicing_index", "results", "splicing_index.RI.txt")
sbi_SE_file <- file.path(root_dir, "analyses", "splicing_index", "results", "splicing_index.SE.txt")


histologies_file <- file.path(data_dir, "v6", "histologies.tsv")
survival_file <- file.path(input_dir, "survival-histologies-base-2023-09-20.tsv")

```

Read in splicing index file, histologies, and updated survival files
```{r}
si_A3SS <- read_table(sbi_A3SS_file) %>%
  rename("Kids_First_Biospecimen_ID"= Sample,
         SI_A3SS = SI)
si_A5SS <- read_table(sbi_A5SS_file) %>%
  dplyr::filter(!is.na(Histology)) %>%
  rename("Kids_First_Biospecimen_ID"= Sample,
         SI_A5SS = SI) %>%
  dplyr::mutate(SI_A5SS = as.double(SI_A5SS))
si_RI <- read_table(sbi_RI_file) %>%
  dplyr::filter(!is.na(Histology)) %>%
  rename("Kids_First_Biospecimen_ID"= Sample,
         SI_RI = SI) %>%
  dplyr::mutate(SI_RI = as.double(SI_RI))
si_SE <- read_table(sbi_SE_file) %>%
  rename("Kids_First_Biospecimen_ID"= Sample,
         SI_SE = SI)

splice_index <- si_A3SS %>%
  left_join(si_A5SS[,c("Kids_First_Biospecimen_ID", "SI_A5SS")]) %>%
  left_join(si_RI[,c("Kids_First_Biospecimen_ID", "SI_RI")]) %>%
  left_join(si_SE[,c("Kids_First_Biospecimen_ID", "SI_SE")])

```

Use `diagnoses` to code in `EFS_status` (event-free status) column indicating event/no event

```{r}
hist <- read_tsv(histologies_file)
survival <- read_tsv(survival_file) %>%
  distinct(Kids_First_Participant_ID, .keep_all = T)

# Add histology columns to splice index, and code EFS_status using following logic
splice_index <- splice_index %>%
  left_join(hist[,c("Kids_First_Biospecimen_ID", "Kids_First_Participant_ID", 
                    "molecular_subtype",
                    "extent_of_tumor_resection")]) %>%
  left_join(survival[,c("Kids_First_Participant_ID",
                        "OS_days", "OS_status",
                        "EFS_days", "EFS_event_type")]) %>%
  distinct(Kids_First_Participant_ID, .keep_all = T) %>%
  dplyr::mutate(EFS_days = as.numeric(EFS_days),
         OS_days = as.numeric(OS_days)) %>%
  dplyr::mutate(OS_years = OS_days/365.25,
         EFS_years = EFS_days/365.25) %>%
  
  # code EFS status using following logic
  dplyr::mutate(EFS_status = case_when(
    EFS_event_type %in% c("Not Applicable", "Not Reported") ~ "NO EVENT",
    !is.na(EFS_event_type) ~ "EVENT",
    TRUE ~ NA_character_
  ))

specimens <- read_tsv(file.path(data_dir, "independent-specimens.rnaseqpanel.primary-plus.tsv"))

dup_pts <- splice_index[duplicated(splice_index$Kids_First_Participant_ID),]$Kids_First_Participant_ID

splice_index <- splice_index %>%
  dplyr::filter(Kids_First_Biospecimen_ID %in% specimens$Kids_First_Biospecimen_ID | !Kids_First_Participant_ID %in% dup_pts)
```

Save to output
```{r}
# Save output
write_tsv(splice_index,
          file.path(results_dir, "splicing_indices_with_survival.tsv"))
```
