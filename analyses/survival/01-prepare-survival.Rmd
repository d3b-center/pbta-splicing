---
title: "Prepare splicing data for survival analyses"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Ryan Corbett
date: 2023
params:
  plot_ci: TRUE
---

**Purpose:** 

- Add sample survival data to splicing index file to run survival analyses
- Add additional subtype data from methylation to improve subtype-specific analyses

## Setup

#### Packages and functions

load libraries and set directories
```{r Set up library}
library(survival)
library(ggpubr)
library(tidyverse)
library(openxlsx)
# Set directories
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
data_dir <- file.path(root_dir, "data")
analysis_dir <- file.path(root_dir, "analyses", "survival")
# Magrittr pipe
`%>%` <- dplyr::`%>%`
```

Set input and results directories

```{r}
input_dir <- file.path(analysis_dir, "input")
results_dir <- file.path(analysis_dir, "results")
```

Set file paths

```{r}
sbi_file <- file.path(root_dir, "analyses", "splicing_index", "results", "splicing_index.total.txt")

histologies_file <- file.path(data_dir, "histologies.tsv")
base_histologies_file <- file.path(input_dir, "histologies-base.tsv")
```

Read in splicing index file, and utilize diagnosis file to code in `PFS_status` column indicating Progression/no progression

```{r}
splice_index <- read_table(sbi_file) %>%
  rename("Kids_First_Biospecimen_ID"= Sample)

hist <- read_tsv(histologies_file)

hist_base <- read_tsv(base_histologies_file)
```

Merge pathology and survival data to `splice_index`

```{r}
# Add histology columns to splice index
splice_index <- splice_index %>%
  left_join(hist[,c("Kids_First_Biospecimen_ID",
                    "molecular_subtype",
                    "extent_of_tumor_resection", 
                    "OS_days", "OS_status",
                    "age_at_diagnosis_days")]) %>%
  
  # EFS_days and EFS_event_type must be pulled from base histologies files
  
  left_join(hist_base[,c("Kids_First_Biospecimen_ID",
                         "EFS_days", "EFS_event_type")]) %>%
  dplyr::mutate(EFS_days = as.numeric(EFS_days)) %>%
  dplyr::mutate(OS_years = OS_days/365.25,
         EFS_years = EFS_days/365.25) %>%
  
  # code EFS status using following logic
    dplyr::mutate(EFS_status = case_when(
    EFS_event_type %in% c("Not Applicable", "Not Reported") ~ "NO EVENT",
    !is.na(EFS_event_type) ~ "EVENT",
    TRUE ~ NA_character_
  ))
```

Save to output

```{r}
write_tsv(splice_index,
          file.path(results_dir, "splicing_indices_with_survival.tsv"))
```
