---
title: "Pan cancer analysis"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

Load required libraries
```{r}
library("limma")
library("gplots")
library("ConsensusClusterPlus")
```

Import files and tables (subset of 30 samples/histology)
PCA plot
```{r}
## filter for inclusion threshold 10, PSI, 80% prev per hist type
file= "/Users/naqvia/Desktop/pan_cancer_rmats/test_matrix.thr10hist30histprev2.psi.tsv"
psi_tab <- read.table(file, row.names = 1, sep = "\t",header = TRUE)

## capture par settings, then add space to the right
opar <- par(no.readonly = TRUE)
par(xpd = TRUE, mar = par()$mar + c(0, 0, 0, 5))

x=plotMDS(log(psi_tab), xlab = "PC1", ylab="PC2", cex.lab= 1, cex = 1, col = c( c(rep("blue", 30)),c(rep("purple",30)), c(rep("black",1 )),c(rep("black",1)), c(rep("violet",30)), c(rep("grey",30)),c(rep("darkred",30)), c(rep("red",30)), c(rep("darkgreen",30)),c(rep("grey",2))), pch=16)
legend(par("usr")[2], par("usr")[4], c("ATRT","Cran","EWS","Embr","Epend","Gangl", "HGAT", "LGAT", "Medullo", "Olig"),col = c("blue","purple","black","black","violet","grey","darkred","red","darkgreen","grey"), pch = 16, bty = "n")

```


Consensus clustering
```{r}
rnames <- psi_tab[,1]
row.names(psi_tab) <- psi_tab$Splice_ID
mat_hm <- data.matrix(psi_tab[,2:ncol(psi_tab)])

d=mat_hm
# d[1:5,1:5]

## reduce the dataset to the top 1,000 most variable genes, measured by median absolute deviation
mads=apply(d,1,mad)
d=d[rev(order(mads))[1:5000],]

## the default settings of the agglomerative hierarchical clustering algorithm using Pearson correlation distance, so it is appropriate to gene median center d using
d = sweep(d,1, apply(d,1,median,na.rm=T))


## remove NAs
is.na(d) <- sapply(d, is.infinite)
d[is.na(d)] <- 0
d[is.nan(d)] <- 0

## Run ConsensusClusterPlus
title="/Users/naqvia/Desktop/pan_cancer_rmats"
results= ConsensusClusterPlus((d),maxK=10,reps=100,pItem=0.8,
                    title="PSI Clustering",clusterAlg="hc",distance="spearman",seed=123,innerLinkage = "average", finalLinkage = "average", plot="png")

ConsensusClusterPlus((d),maxK=10,reps=100,pItem=0.8,
                     title="clustering",clusterAlg="hc",distance="spearman",seed=123,innerLinkage = "average", finalLinkage = "average")

## do all of the samples 
file = "/Users/naqvia/Desktop/pan_cancer_rmats/test_matrix.thr10histTotalhistprev2.psi.csv"
psi_tab <- read.csv(file, row.names = 1,header = TRUE)

rnames <- psi_tab[,1]
row.names(psi_tab) <- psi_tab$Splice_ID
mat_hm <- data.matrix(psi_tab[,2:ncol(psi_tab)])

d=mat_hm

## reduce the dataset to the top 1,000 most variable genes, measured by median absolute deviation
mads=apply(d,1,mad)
d=d[rev(order(mads))[1:5000],]

## the default settings of the agglomerative hierarchical clustering algorithm using Pearson correlation distance, so it is appropriate to gene median center d using
d = sweep(d,1, apply(d,1,median,na.rm=T))


## remove NAs
is.na(d) <- sapply(d, is.infinite)
d[is.na(d)] <- 0
d[is.nan(d)] <- 0

ConsensusClusterPlus((d),maxK=10,reps=100,pItem=0.8,
                     title="clustering",clusterAlg="hc",distance="spearman",seed=123,innerLinkage = "average", finalLinkage = "average")

##save to file
title="/Users/naqvia/Desktop/pan_cancer_rmats"
results= ConsensusClusterPlus((d),maxK=10,reps=100,pItem=0.8,
                     title="Total Samples PSI Clustering",clusterAlg="hc",distance="spearman",seed=123,innerLinkage = "average", finalLinkage = "average", plot="png")


```
Heatmap with hierarchical clustering
```{r}

heatmap.2(((d)),
         notecol="black",      # change font color of cell labels to black
        dendrogram="col",
        col=redgreen)
```

##Splicing index plot
```{r}
library(ggplot2)
library(dplyr)
library(hrbrthemes)
library(viridis)

file = "/Users/naqvia/Desktop/AS-DMG/analyses/pan_cancer/results/splicing_index.v2.txt"
splice_index = read.table(file,header=TRUE, row.names=1, sep = "\t")

e <- ggplot(splice_index, aes(x = hist, y = splice_index))


e + geom_violin(trim = FALSE) + 
  stat_summary(
    fun.data = "mean_sdl",  fun.args = list(mult = 1), 
    geom = "pointrange", color = "black"
  )

e + geom_violin(aes(fill = hist), trim = FALSE) + 
  geom_boxplot(width = 0.2) +
  #scale_fill_manual(values = c("#00AFBB", "#E7B800", "#FC4E07")) +
  geom_point(color="black", size=1, position = position_jitter(w=0.02)) +
  theme(legend.position = "none") + theme_Publication()




```

