---
title: "Pan cancer analysis"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

Load required libraries
```{r}
library("limma")
library("gplots")
library("ConsensusClusterPlus")
```

Import files and tables (subset of 30 samples/histology)
PCA plot
```{r}
## filter for inclusion threshold 10, PSI, 80% prev per hist type
file= "/Users/naqvia/Desktop/pan_cancer_rmats/test_matrix.thr10hist30histprev2.psi.tsv"
psi_tab <- read.table(file, row.names = 1, sep = "\t",header = TRUE)

## capture par settings, then add space to the right
opar <- par(no.readonly = TRUE)
par(xpd = TRUE, mar = par()$mar + c(0, 0, 0, 5))

x=plotMDS(log(psi_tab), xlab = "PC1", ylab="PC2", cex.lab= 1, cex = 1, col = c( c(rep("blue", 30)),c(rep("purple",30)), c(rep("black",1 )),c(rep("black",1)), c(rep("violet",30)), c(rep("grey",30)),c(rep("darkred",30)), c(rep("red",30)), c(rep("darkgreen",30)),c(rep("grey",2))), pch=16)
legend(par("usr")[2], par("usr")[4], c("ATRT","Cran","EWS","Embr","Epend","Gangl", "HGAT", "LGAT", "Medullo", "Olig"),col = c("blue","purple","black","black","violet","grey","darkred","red","darkgreen","grey"), pch = 16, bty = "n")

```

Heatmap with hiearchical clustering
```{r}
rnames <- psi_tab[,1]
row.names(psi_tab) <- psi_tab$Splice_ID
mat_hm <- data.matrix(psi_tab[,2:ncol(psi_tab)])

#heatmap.2(((mat_hm)),
 #         notecol="black",      # change font color of cell labels to black
 #        dendrogram="col",
 #       col=redgreen)
```

Consensus clustering
```{r}

d=mat_hm
# d[1:5,1:5]

## reduce the dataset to the top 1,000 most variable genes, measured by median absolute deviation
mads=apply(d,1,mad)
d=d[rev(order(mads))[1:1000],]

## the default settings of the agglomerative hierarchical clustering algorithm using Pearson correlation distance, so it is appropriate to gene median center d using
d = sweep(d,1, apply(d,1,median,na.rm=T))


## remove NAs
is.na(d) <- sapply(d, is.infinite)
d[is.na(d)] <- 0
d[is.nan(d)] <- 0


## Run ConsensusClusterPlus
title="/Users/naqvia/Desktop/pan_cancer_rmats"
results= ConsensusClusterPlus((d),maxK=10,reps=100,pItem=0.8,
                     title="PSI Clustering",clusterAlg="hc",distance="spearman",seed=123,innerLinkage = "average", finalLinkage = "average", plot="png")

ConsensusClusterPlus((d),maxK=10,reps=100,pItem=0.8,
                     title="PSI Clustering",clusterAlg="hc",distance="spearman",seed=123,innerLinkage = "average", finalLinkage = "average")
```
